import{_ as ve}from"./_plugin-vue_export-helper-BwE83l92.js";/* empty css               *//* empty css                */import"./el-form-item-l0sNRNKZ.js";/* empty css                 *//* empty css                *//* empty css               *//* empty css                    *//* empty css                  *//* empty css                  */import{y as fe,r as n,l as L,c as D,j as pe,U as _e,z as A,B as s,R as l,J as r,A as x,O as p,u as g,P as d,L as U,I as J,aC as ge}from"./vendor-BcB6VvZI.js";import{c as be,aq as he,b as ye,C as we,ar as ke,y as Ce,G as Ee,aD as xe,j as Ve,J as Pe,ap as Ue,ab as Ie,d as Ae,e as $e,f as Te,w as ze,aj as Me,E as o}from"./element-CHj0RLGm.js";import{b as Be,f as O}from"./helpers-iwoUo1o7.js";import{u as De,a as F}from"./index-ourEn2z0.js";const Fe={class:"profile-page"},Ne={class:"page-header"},Re={class:"header-content"},Se={class:"header-actions"},je={class:"profile-content"},qe={class:"card-header"},Le={class:"profile-info"},Je={class:"avatar-section"},Oe={class:"avatar-actions"},We={key:0,class:"upload-progress"},Ge={class:"progress-text"},He={class:"basic-info"},Ze={class:"info-item"},Ke={class:"value"},Qe={class:"info-item"},Xe={class:"value"},Ye={class:"info-item"},ea={class:"info-item"},aa={class:"value"},la={key:0,class:"email-verification-section"},ta={class:"verification-input-row"},sa={key:0,class:"code-tips"},ra={class:"code-timer"},oa={class:"storage-info"},ia={class:"storage-text"},na=fe({__name:"ProfilePage",setup(ua){const $=De();ge();const T=n(!1),z=n(!1);n(!1);const m=n(!1),_=n(!1),f=n(0),b=n(""),M=n();n();const w=n(""),h=n(""),V=n(!1),c=n(0),y=n(0),k=n(null),C=n(null),t=L({id:0,username:"",email:"",nickname:"",bio:"",avatar_url:"",role:"",storage_limit:0,used_storage:0,created_at:""});L({currentPassword:"",newPassword:"",confirmPassword:""});const W={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:3,max:20,message:"用户名长度在 3 到 20 个字符",trigger:"blur"},{pattern:/^[a-zA-Z0-9_]+$/,message:"用户名只能包含字母、数字和下划线",trigger:"blur"},{validator:(a,e,i)=>{e&&e.includes("@")?i(new Error("用户名不能使用邮箱格式")):i()},trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{type:"email",message:"请输入正确的邮箱格式",trigger:"blur"}],nickname:[{max:50,message:"昵称长度不能超过 50 个字符",trigger:"blur"}],bio:[{max:200,message:"个人简介长度不能超过 200 个字符",trigger:"blur"}]},N=D(()=>t.storage_limit?Math.round(t.used_storage/t.storage_limit*100):0),G=D(()=>"https://tukubackend.vtart.cn/api/files/upload/avatar"),H=D(()=>({Authorization:`Bearer ${$.token}`})),R=async()=>{var a,e;if(!t.email||t.email===w.value){o.warning("请输入新的邮箱地址");return}try{const i=await F.post("/auth/send-email-code",{email:t.email,type:"change_email"});i.data.success?(o.success("验证码已发送到您的邮箱"),V.value=!0,K(),Q()):o.error(i.data.message||"发送验证码失败")}catch(i){const v=((e=(a=i.response)==null?void 0:a.data)==null?void 0:e.message)||"发送验证码失败";o.error(v)}},Z=async()=>{if(c.value>0){o.warning(`请等待 ${c.value} 秒后再试`);return}await R()},K=()=>{c.value=60,k.value=setInterval(()=>{c.value--,c.value<=0&&(clearInterval(k.value),k.value=null)},1e3)},Q=()=>{y.value=300,C.value=setInterval(()=>{y.value--,y.value<=0&&(clearInterval(C.value),C.value=null,V.value=!1,h.value="",o.warning("验证码已过期，请重新发送"))},1e3)},B=()=>{k.value&&(clearInterval(k.value),k.value=null),C.value&&(clearInterval(C.value),C.value=null)},X=async()=>{T.value=!0;try{await I(),o.success("个人信息已刷新")}catch{o.error("刷新个人信息失败")}finally{T.value=!1}},I=async()=>{try{const e=(await F.get("/auth/me")).data.user;Object.assign(t,{id:e.id,username:e.username,email:e.email,nickname:e.nickname||"",bio:e.bio||"",avatar_url:e.avatar_url?e.avatar_url.startsWith("http")?e.avatar_url:`https://tukubackend.vtart.cn${e.avatar_url}`:"",role:e.role,storage_limit:e.storage_limit,used_storage:e.used_storage,created_at:e.created_at}),w.value=e.email}catch(a){throw a}},Y=async()=>{var a,e;if(M.value)try{if(await M.value.validate(),t.email!==w.value){if(!h.value){o.warning("请先发送并输入邮箱验证码");return}if(y.value<=0){o.warning("验证码已过期，请重新发送");return}}z.value=!0;const i={username:t.username,nickname:t.nickname,bio:t.bio};t.email!==w.value&&(i.email=t.email,i.emailCode=h.value),await F.put("/auth/profile",i),o.success("个人信息保存成功"),m.value=!1,B(),V.value=!1,h.value="",c.value=0,y.value=0,await $.checkAuth()}catch(i){const v=((e=(a=i.response)==null?void 0:a.data)==null?void 0:e.message)||"保存个人信息失败";o.error(v)}finally{z.value=!1}},ee=()=>{m.value=!1,B(),V.value=!1,h.value="",c.value=0,y.value=0,t.email=w.value,I()},ae=a=>{if(_.value=!1,f.value=0,b.value="",a&&a.success&&a.data&&a.data.url){const e=a.data.url+"?t="+Date.now();t.avatar_url=e,o.success(a.message||"头像上传成功"),$.updateUser({avatar_url:e}),I()}else o.error(a.message||"头像上传失败")},le=a=>{f.value=Math.round(a.percent),a.percent<100?b.value=`上传中... ${f.value}%`:(b.value="服务器处理中，请稍候...",f.value=95)},te=a=>{_.value=!1,f.value=0,b.value="",a.message?a.message.includes("Unexpected field")?o.error("上传字段错误，请重试"):a.message.includes("Network Error")?o.error("网络错误，请检查网络连接"):a.message.includes("401")?o.error("登录已过期，请重新登录"):o.error(`上传失败：${a.message}`):o.error("头像上传失败，请重试")},se=a=>`${a}%`,re=a=>{const e=a.type.startsWith("image/"),i=a.size/1024/1024<10;return e?i?(_.value=!0,f.value=0,b.value="准备上传...",setTimeout(()=>{_.value&&f.value<100&&o.warning("上传时间较长，请耐心等待...")},1e4),setTimeout(()=>{_.value&&f.value<100&&(_.value=!1,f.value=0,b.value="",o.error("上传超时，请重试"))},6e4),!0):(o.error("图片大小不能超过 10MB!"),!1):(o.error("只能上传图片文件!"),!1)},oe=a=>a>=90?"#f56c6c":a>=70?"#e6a23c":"#67c23a",ie=a=>{if(!a)return"未知";try{return new Date(a).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}catch{return a}};return pe(()=>{I()}),_e(()=>{B()}),(a,e)=>{const i=ye,v=be,ne=Ee,ue=xe,S=Pe,de=Ue,j=Ce,q=ke,P=Te,E=$e,ce=Ae,me=he;return x(),A("div",Fe,[s("div",Ne,[s("div",Re,[e[7]||(e[7]=s("div",{class:"header-left"},[s("h1",{class:"page-title"},"个人资料"),s("p",{class:"page-subtitle"},"管理您的个人信息和账户设置")],-1)),s("div",Se,[l(v,{onClick:X,loading:T.value},{default:r(()=>[l(i,null,{default:r(()=>[l(g(we))]),_:1}),e[6]||(e[6]=p(" 刷新 ",-1))]),_:1},8,["loading"])])])]),s("div",je,[l(me,{gutter:24},{default:r(()=>[l(q,{xs:24,md:8},{default:r(()=>[l(j,{class:"profile-card"},{header:r(()=>[s("div",qe,[e[8]||(e[8]=s("span",null,"个人信息",-1)),l(v,{type:"text",onClick:e[0]||(e[0]=u=>m.value=!m.value)},{default:r(()=>[l(i,null,{default:r(()=>[l(g(Ie))]),_:1}),p(" "+d(m.value?"取消编辑":"编辑"),1)]),_:1})])]),default:r(()=>[s("div",Le,[s("div",Je,[l(ne,{size:120,src:t.avatar_url,class:"profile-avatar"},{default:r(()=>{var u;return[p(d((u=t.username)==null?void 0:u.charAt(0).toUpperCase()),1)]}),_:1},8,["src"]),s("div",Oe,[l(ue,{class:"avatar-uploader",action:G.value,headers:H.value,"show-file-list":!1,"on-success":ae,"on-progress":le,"before-upload":re,"on-error":te,name:"avatar",accept:"image/*"},{default:r(()=>[l(v,{type:"primary",size:"small",loading:_.value},{default:r(()=>[l(i,null,{default:r(()=>[l(g(Ve))]),_:1}),p(" "+d(_.value?"上传中...":"更换头像"),1)]),_:1},8,["loading"])]),_:1},8,["action","headers"]),_.value?(x(),A("div",We,[l(S,{percentage:f.value,"stroke-width":6,"show-text":!0,format:se},null,8,["percentage"]),s("div",Ge,d(b.value),1)])):U("",!0)])]),s("div",He,[s("div",Ze,[e[9]||(e[9]=s("span",{class:"label"},"用户名",-1)),s("span",Ke,d(t.username),1)]),s("div",Qe,[e[10]||(e[10]=s("span",{class:"label"},"邮箱",-1)),s("span",Xe,d(t.email),1)]),s("div",Ye,[e[11]||(e[11]=s("span",{class:"label"},"角色",-1)),l(de,{type:t.role==="admin"?"danger":"primary"},{default:r(()=>[p(d(t.role==="admin"?"管理员":"用户"),1)]),_:1},8,["type"])]),s("div",ea,[e[12]||(e[12]=s("span",{class:"label"},"注册时间",-1)),s("span",aa,d(ie(t.created_at)),1)])])])]),_:1})]),_:1}),l(q,{xs:24,md:16},{default:r(()=>[l(j,{class:"details-card"},{header:r(()=>[...e[13]||(e[13]=[s("span",null,"详细信息",-1)])]),default:r(()=>[l(ce,{model:t,rules:W,ref_key:"profileFormRef",ref:M,"label-width":"100px",class:"profile-form"},{default:r(()=>[l(E,{label:"用户名",prop:"username"},{default:r(()=>[l(P,{modelValue:t.username,"onUpdate:modelValue":e[1]||(e[1]=u=>t.username=u),disabled:!m.value,placeholder:"请输入用户名"},null,8,["modelValue","disabled"])]),_:1}),l(E,{label:"邮箱",prop:"email"},{default:r(()=>[l(P,{modelValue:t.email,"onUpdate:modelValue":e[2]||(e[2]=u=>t.email=u),disabled:!m.value,placeholder:"请输入新邮箱",class:"email-input"},null,8,["modelValue","disabled"]),m.value&&t.email&&t.email!==w.value?(x(),A("div",la,[e[14]||(e[14]=s("div",{class:"verification-header"},[s("span",{class:"verification-title"},"邮箱验证")],-1)),s("div",ta,[l(P,{modelValue:h.value,"onUpdate:modelValue":e[3]||(e[3]=u=>h.value=u),placeholder:"请输入6位验证码",class:"email-code-input",maxlength:"6"},null,8,["modelValue"]),l(v,{type:"primary",size:"small",disabled:c.value>0,onClick:R,class:"send-code-btn"},{default:r(()=>[p(d(c.value>0?`${c.value}s`:"发送验证码"),1)]),_:1},8,["disabled"])]),V.value?(x(),A("div",sa,[s("span",ra,"验证码有效期："+d(y.value)+"s",1),l(v,{type:"text",onClick:Z,disabled:c.value>0},{default:r(()=>[p(d(c.value>0?`${c.value}s后重发`:"重新发送"),1)]),_:1},8,["disabled"])])):U("",!0)])):U("",!0)]),_:1}),l(E,{label:"昵称",prop:"nickname"},{default:r(()=>[l(P,{modelValue:t.nickname,"onUpdate:modelValue":e[4]||(e[4]=u=>t.nickname=u),disabled:!m.value,placeholder:"请输入昵称"},null,8,["modelValue","disabled"])]),_:1}),l(E,{label:"个人简介",prop:"bio"},{default:r(()=>[l(P,{modelValue:t.bio,"onUpdate:modelValue":e[5]||(e[5]=u=>t.bio=u),disabled:!m.value,type:"textarea",rows:3,placeholder:"请输入个人简介"},null,8,["modelValue","disabled"])]),_:1}),m.value?U("",!0):(x(),J(E,{key:0,label:"存储使用"},{default:r(()=>[s("div",oa,[l(S,{percentage:N.value,color:oe(N.value),"stroke-width":8},{default:r(({percentage:u})=>[p(d(g(Be)(u)),1)]),_:1},8,["percentage","color"]),s("div",ia,d(g(O)(t.used_storage||0))+" / "+d(g(O)(t.storage_limit||0)),1)])]),_:1})),m.value?(x(),J(E,{key:1},{default:r(()=>[l(v,{type:"primary",onClick:Y,loading:z.value},{default:r(()=>[l(i,null,{default:r(()=>[l(g(ze))]),_:1}),e[15]||(e[15]=p(" 保存修改 ",-1))]),_:1},8,["loading"]),l(v,{onClick:ee},{default:r(()=>[l(i,null,{default:r(()=>[l(g(Me))]),_:1}),e[16]||(e[16]=p(" 取消 ",-1))]),_:1})]),_:1})):U("",!0)]),_:1},8,["model"])]),_:1})]),_:1})]),_:1})])])}}}),Ea=ve(na,[["__scopeId","data-v-4b739e97"]]);export{Ea as default};
