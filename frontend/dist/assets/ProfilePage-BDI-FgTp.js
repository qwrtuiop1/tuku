import{_ as ve}from"./_plugin-vue_export-helper-BwE83l92.js";/* empty css               *//* empty css                */import"./el-form-item-l0sNRNKZ.js";/* empty css                 *//* empty css                *//* empty css               *//* empty css                    *//* empty css                  *//* empty css                  */import{y as fe,r as i,l as q,c as B,j as pe,U as _e,z as A,B as s,R as t,J as r,A as x,O as p,u as g,P as d,L as U,I as J,aC as ge}from"./vendor-BcB6VvZI.js";import{c as be,aq as he,b as ye,C as we,ar as ke,y as Ce,G as Ee,aD as xe,j as Ve,J as Pe,ap as Ue,ab as Ie,d as Ae,e as $e,f as Te,w as ze,aj as Me,E as o}from"./element-CHj0RLGm.js";import{b as Re,f as O}from"./helpers-iwoUo1o7.js";import{u as Be,a as D}from"./index-JAZUU9Ah.js";const De={class:"profile-page"},Fe={class:"page-header"},Le={class:"header-content"},Ne={class:"header-actions"},Se={class:"profile-content"},je={class:"card-header"},qe={class:"profile-info"},Je={class:"avatar-section"},Oe={class:"avatar-actions"},We={key:0,class:"upload-progress"},Ge={class:"progress-text"},He={class:"basic-info"},Ze={class:"info-item"},Ke={class:"value"},Qe={class:"info-item"},Xe={class:"value"},Ye={class:"info-item"},ea={class:"info-item"},aa={class:"value"},la={key:0,class:"email-verification-section"},ta={class:"verification-input-row"},sa={key:0,class:"code-tips"},ra={class:"code-timer"},oa={class:"storage-info"},na={class:"storage-text"},ia=fe({__name:"ProfilePage",setup(ua){const $=Be();ge();const T=i(!1),z=i(!1);i(!1);const m=i(!1),_=i(!1),f=i(0),b=i(""),M=i();i();const w=i(""),h=i(""),V=i(!1),c=i(0),y=i(0),k=i(null),C=i(null),l=q({id:0,username:"",email:"",nickname:"",bio:"",avatar_url:"",role:"",storage_limit:0,used_storage:0,created_at:""});q({currentPassword:"",newPassword:"",confirmPassword:""});const W={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:3,max:20,message:"用户名长度在 3 到 20 个字符",trigger:"blur"},{pattern:/^[a-zA-Z0-9_]+$/,message:"用户名只能包含字母、数字和下划线",trigger:"blur"},{validator:(a,e,n)=>{e&&e.includes("@")?n(new Error("用户名不能使用邮箱格式")):n()},trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{type:"email",message:"请输入正确的邮箱格式",trigger:"blur"}],nickname:[{max:50,message:"昵称长度不能超过 50 个字符",trigger:"blur"}],bio:[{max:200,message:"个人简介长度不能超过 200 个字符",trigger:"blur"}]},F=B(()=>l.storage_limit?Math.round(l.used_storage/l.storage_limit*100):0),G=B(()=>"https://tukubackend.vtart.cn/api/files/upload/avatar"),H=B(()=>({Authorization:`Bearer ${$.token}`})),L=async()=>{var a,e;if(!l.email||l.email===w.value){o.warning("请输入新的邮箱地址");return}try{const n=await D.post("/auth/send-email-code",{email:l.email,type:"change_email"});n.data.success?(o.success("验证码已发送到您的邮箱"),V.value=!0,K(),Q()):o.error(n.data.message||"发送验证码失败")}catch(n){const v=((e=(a=n.response)==null?void 0:a.data)==null?void 0:e.message)||"发送验证码失败";o.error(v)}},Z=async()=>{if(c.value>0){o.warning(`请等待 ${c.value} 秒后再试`);return}await L()},K=()=>{c.value=60,k.value=setInterval(()=>{c.value--,c.value<=0&&(clearInterval(k.value),k.value=null)},1e3)},Q=()=>{y.value=300,C.value=setInterval(()=>{y.value--,y.value<=0&&(clearInterval(C.value),C.value=null,V.value=!1,h.value="",o.warning("验证码已过期，请重新发送"))},1e3)},R=()=>{k.value&&(clearInterval(k.value),k.value=null),C.value&&(clearInterval(C.value),C.value=null)},X=async()=>{T.value=!0;try{await I(),o.success("个人信息已刷新")}catch(a){console.error("刷新个人信息失败:",a),o.error("刷新个人信息失败")}finally{T.value=!1}},I=async()=>{try{const e=(await D.get("/auth/me")).data.user;Object.assign(l,{id:e.id,username:e.username,email:e.email,nickname:e.nickname||"",bio:e.bio||"",avatar_url:e.avatar_url?e.avatar_url.startsWith("http")?e.avatar_url:`https://tukubackend.vtart.cn${e.avatar_url}`:"",role:e.role,storage_limit:e.storage_limit,used_storage:e.used_storage,created_at:e.created_at}),w.value=e.email}catch(a){throw console.error("获取个人信息失败:",a),a}},Y=async()=>{var a,e;if(M.value)try{if(await M.value.validate(),l.email!==w.value){if(!h.value){o.warning("请先发送并输入邮箱验证码");return}if(y.value<=0){o.warning("验证码已过期，请重新发送");return}}z.value=!0;const n={username:l.username,nickname:l.nickname,bio:l.bio};l.email!==w.value&&(n.email=l.email,n.emailCode=h.value),await D.put("/auth/profile",n),o.success("个人信息保存成功"),m.value=!1,R(),V.value=!1,h.value="",c.value=0,y.value=0,await $.checkAuth()}catch(n){console.error("保存个人信息失败:",n);const v=((e=(a=n.response)==null?void 0:a.data)==null?void 0:e.message)||"保存个人信息失败";o.error(v)}finally{z.value=!1}},ee=()=>{m.value=!1,R(),V.value=!1,h.value="",c.value=0,y.value=0,l.email=w.value,I()},ae=a=>{if(_.value=!1,f.value=0,b.value="",console.log("头像上传响应:",a),a&&a.success&&a.data&&a.data.url){console.log("头像URL:",a.data.url),console.log("更新前头像URL:",l.avatar_url);const e=a.data.url+"?t="+Date.now();l.avatar_url=e,console.log("更新后头像URL:",l.avatar_url),o.success(a.message||"头像上传成功"),$.updateUser({avatar_url:e}),I()}else o.error(a.message||"头像上传失败")},le=a=>{f.value=Math.round(a.percent),a.percent<100?b.value=`上传中... ${f.value}%`:(b.value="服务器处理中，请稍候...",f.value=95)},te=a=>{_.value=!1,f.value=0,b.value="",console.error("头像上传失败:",a),a.message?a.message.includes("Unexpected field")?o.error("上传字段错误，请重试"):a.message.includes("Network Error")?o.error("网络错误，请检查网络连接"):a.message.includes("401")?o.error("登录已过期，请重新登录"):o.error(`上传失败：${a.message}`):o.error("头像上传失败，请重试")},se=a=>`${a}%`,re=a=>{const e=a.type.startsWith("image/"),n=a.size/1024/1024<10;return e?n?(_.value=!0,f.value=0,b.value="准备上传...",setTimeout(()=>{_.value&&f.value<100&&o.warning("上传时间较长，请耐心等待...")},1e4),setTimeout(()=>{_.value&&f.value<100&&(_.value=!1,f.value=0,b.value="",o.error("上传超时，请重试"))},6e4),!0):(o.error("图片大小不能超过 10MB!"),!1):(o.error("只能上传图片文件!"),!1)},oe=a=>a>=90?"#f56c6c":a>=70?"#e6a23c":"#67c23a",ne=a=>{if(!a)return"未知";try{return new Date(a).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}catch{return a}};return pe(()=>{I()}),_e(()=>{R()}),(a,e)=>{const n=ye,v=be,ie=Ee,ue=xe,N=Pe,de=Ue,S=Ce,j=ke,P=Te,E=$e,ce=Ae,me=he;return x(),A("div",De,[s("div",Fe,[s("div",Le,[e[7]||(e[7]=s("div",{class:"header-left"},[s("h1",{class:"page-title"},"个人资料"),s("p",{class:"page-subtitle"},"管理您的个人信息和账户设置")],-1)),s("div",Ne,[t(v,{onClick:X,loading:T.value},{default:r(()=>[t(n,null,{default:r(()=>[t(g(we))]),_:1}),e[6]||(e[6]=p(" 刷新 ",-1))]),_:1},8,["loading"])])])]),s("div",Se,[t(me,{gutter:24},{default:r(()=>[t(j,{xs:24,md:8},{default:r(()=>[t(S,{class:"profile-card"},{header:r(()=>[s("div",je,[e[8]||(e[8]=s("span",null,"个人信息",-1)),t(v,{type:"text",onClick:e[0]||(e[0]=u=>m.value=!m.value)},{default:r(()=>[t(n,null,{default:r(()=>[t(g(Ie))]),_:1}),p(" "+d(m.value?"取消编辑":"编辑"),1)]),_:1})])]),default:r(()=>[s("div",qe,[s("div",Je,[t(ie,{size:120,src:l.avatar_url,class:"profile-avatar"},{default:r(()=>{var u;return[p(d((u=l.username)==null?void 0:u.charAt(0).toUpperCase()),1)]}),_:1},8,["src"]),s("div",Oe,[t(ue,{class:"avatar-uploader",action:G.value,headers:H.value,"show-file-list":!1,"on-success":ae,"on-progress":le,"before-upload":re,"on-error":te,name:"avatar",accept:"image/*"},{default:r(()=>[t(v,{type:"primary",size:"small",loading:_.value},{default:r(()=>[t(n,null,{default:r(()=>[t(g(Ve))]),_:1}),p(" "+d(_.value?"上传中...":"更换头像"),1)]),_:1},8,["loading"])]),_:1},8,["action","headers"]),_.value?(x(),A("div",We,[t(N,{percentage:f.value,"stroke-width":6,"show-text":!0,format:se},null,8,["percentage"]),s("div",Ge,d(b.value),1)])):U("",!0)])]),s("div",He,[s("div",Ze,[e[9]||(e[9]=s("span",{class:"label"},"用户名",-1)),s("span",Ke,d(l.username),1)]),s("div",Qe,[e[10]||(e[10]=s("span",{class:"label"},"邮箱",-1)),s("span",Xe,d(l.email),1)]),s("div",Ye,[e[11]||(e[11]=s("span",{class:"label"},"角色",-1)),t(de,{type:l.role==="admin"?"danger":"primary"},{default:r(()=>[p(d(l.role==="admin"?"管理员":"用户"),1)]),_:1},8,["type"])]),s("div",ea,[e[12]||(e[12]=s("span",{class:"label"},"注册时间",-1)),s("span",aa,d(ne(l.created_at)),1)])])])]),_:1})]),_:1}),t(j,{xs:24,md:16},{default:r(()=>[t(S,{class:"details-card"},{header:r(()=>[...e[13]||(e[13]=[s("span",null,"详细信息",-1)])]),default:r(()=>[t(ce,{model:l,rules:W,ref_key:"profileFormRef",ref:M,"label-width":"100px",class:"profile-form"},{default:r(()=>[t(E,{label:"用户名",prop:"username"},{default:r(()=>[t(P,{modelValue:l.username,"onUpdate:modelValue":e[1]||(e[1]=u=>l.username=u),disabled:!m.value,placeholder:"请输入用户名"},null,8,["modelValue","disabled"])]),_:1}),t(E,{label:"邮箱",prop:"email"},{default:r(()=>[t(P,{modelValue:l.email,"onUpdate:modelValue":e[2]||(e[2]=u=>l.email=u),disabled:!m.value,placeholder:"请输入新邮箱",class:"email-input"},null,8,["modelValue","disabled"]),m.value&&l.email&&l.email!==w.value?(x(),A("div",la,[e[14]||(e[14]=s("div",{class:"verification-header"},[s("span",{class:"verification-title"},"邮箱验证")],-1)),s("div",ta,[t(P,{modelValue:h.value,"onUpdate:modelValue":e[3]||(e[3]=u=>h.value=u),placeholder:"请输入6位验证码",class:"email-code-input",maxlength:"6"},null,8,["modelValue"]),t(v,{type:"primary",size:"small",disabled:c.value>0,onClick:L,class:"send-code-btn"},{default:r(()=>[p(d(c.value>0?`${c.value}s`:"发送验证码"),1)]),_:1},8,["disabled"])]),V.value?(x(),A("div",sa,[s("span",ra,"验证码有效期："+d(y.value)+"s",1),t(v,{type:"text",onClick:Z,disabled:c.value>0},{default:r(()=>[p(d(c.value>0?`${c.value}s后重发`:"重新发送"),1)]),_:1},8,["disabled"])])):U("",!0)])):U("",!0)]),_:1}),t(E,{label:"昵称",prop:"nickname"},{default:r(()=>[t(P,{modelValue:l.nickname,"onUpdate:modelValue":e[4]||(e[4]=u=>l.nickname=u),disabled:!m.value,placeholder:"请输入昵称"},null,8,["modelValue","disabled"])]),_:1}),t(E,{label:"个人简介",prop:"bio"},{default:r(()=>[t(P,{modelValue:l.bio,"onUpdate:modelValue":e[5]||(e[5]=u=>l.bio=u),disabled:!m.value,type:"textarea",rows:3,placeholder:"请输入个人简介"},null,8,["modelValue","disabled"])]),_:1}),m.value?U("",!0):(x(),J(E,{key:0,label:"存储使用"},{default:r(()=>[s("div",oa,[t(N,{percentage:F.value,color:oe(F.value),"stroke-width":8},{default:r(({percentage:u})=>[p(d(g(Re)(u)),1)]),_:1},8,["percentage","color"]),s("div",na,d(g(O)(l.used_storage||0))+" / "+d(g(O)(l.storage_limit||0)),1)])]),_:1})),m.value?(x(),J(E,{key:1},{default:r(()=>[t(v,{type:"primary",onClick:Y,loading:z.value},{default:r(()=>[t(n,null,{default:r(()=>[t(g(ze))]),_:1}),e[15]||(e[15]=p(" 保存修改 ",-1))]),_:1},8,["loading"]),t(v,{onClick:ee},{default:r(()=>[t(n,null,{default:r(()=>[t(g(Me))]),_:1}),e[16]||(e[16]=p(" 取消 ",-1))]),_:1})]),_:1})):U("",!0)]),_:1},8,["model"])]),_:1})]),_:1})]),_:1})])])}}}),Ea=ve(ia,[["__scopeId","data-v-a333e154"]]);export{Ea as default};
