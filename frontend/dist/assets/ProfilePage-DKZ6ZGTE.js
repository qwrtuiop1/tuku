import{_ as ve}from"./_plugin-vue_export-helper-BwE83l92.js";/* empty css               *//* empty css                */import"./el-form-item-l0sNRNKZ.js";/* empty css                 *//* empty css                *//* empty css               *//* empty css                    *//* empty css                  *//* empty css                  */import{y as pe,r as u,l as O,c as F,j as fe,U as _e,z as I,B as t,R as s,J as r,A as x,O as f,u as g,P as c,L as U,I as J,aC as ge}from"./vendor-zXVeQ_Lg.js";import{c as be,aq as he,b as ye,C as ke,as as we,y as Ce,G as Ee,aL as xe,j as Ve,J as Pe,ap as Ae,ab as Ue,d as Ie,e as $e,f as Be,w as Te,aj as ze,E as o}from"./element-EMRHCpUD.js";import{b as Me,f as W}from"./helpers-Bt27ni5u.js";import{u as Ne,a as $}from"./index-Czg_G3sW.js";const De={class:"profile-page"},Fe={class:"page-header"},Re={class:"header-content"},je={class:"header-actions"},Se={class:"profile-content"},Le={class:"card-header"},qe={class:"profile-info"},Oe={class:"avatar-section"},Je={class:"avatar-actions"},We={key:0,class:"upload-progress"},Ge={class:"progress-text"},He={class:"basic-info"},Ze={class:"info-item"},Ke={class:"value"},Qe={class:"info-item"},Xe={class:"value"},Ye={class:"info-item"},ea={class:"info-item"},aa={class:"value"},la={key:0,class:"email-verification-section"},sa={class:"verification-input-row"},ta={key:0,class:"code-tips"},ra={class:"code-timer"},oa={class:"storage-info"},ia={class:"storage-text"},na=pe({__name:"ProfilePage",setup(ua){const B=Ne();ge();const T=u(!1),z=u(!1);u(!1);const v=u(!1),_=u(!1),p=u(0),b=u(""),M=u();u();const h=u(""),y=u(""),V=u(!1),m=u(0),k=u(0),w=u(null),C=u(null),l=O({id:0,username:"",email:"",nickname:"",bio:"",avatar_url:"",role:"",storage_limit:0,used_storage:0,created_at:""});O({currentPassword:"",newPassword:"",confirmPassword:""});const G={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:3,max:20,message:"用户名长度在 3 到 20 个字符",trigger:"blur"},{pattern:/^[a-zA-Z0-9_]+$/,message:"用户名只能包含字母、数字和下划线",trigger:"blur"},{validator:(a,e,i)=>{e&&e.includes("@")?i(new Error("用户名不能使用邮箱格式")):i()},trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{type:"email",message:"请输入正确的邮箱格式",trigger:"blur"}],nickname:[{max:50,message:"昵称长度不能超过 50 个字符",trigger:"blur"}],bio:[{max:200,message:"个人简介长度不能超过 200 个字符",trigger:"blur"}]},R=F(()=>l.storage_limit?Math.round(l.used_storage/l.storage_limit*100):0),H=F(()=>"https://tukubackend.vtart.cn/api/files/upload/avatar"),Z=F(()=>({Authorization:`Bearer ${B.token}`})),j=async()=>{var a,e;if(!l.email||l.email===h.value){o.warning("请输入新的邮箱地址");return}try{const i=await $.post("/auth/send-email-code",{email:l.email,type:"change_email"});i.data.success?(o.success("验证码已发送到您的邮箱"),V.value=!0,Q(),X()):o.error(i.data.message||"发送验证码失败")}catch(i){const n=((e=(a=i.response)==null?void 0:a.data)==null?void 0:e.message)||"发送验证码失败";o.error(n)}},K=async()=>{if(m.value>0){o.warning(`请等待 ${m.value} 秒后再试`);return}await j()},Q=()=>{m.value=60,w.value=setInterval(()=>{m.value--,m.value<=0&&(clearInterval(w.value),w.value=null)},1e3)},X=()=>{k.value=300,C.value=setInterval(()=>{k.value--,k.value<=0&&(clearInterval(C.value),C.value=null,V.value=!1,y.value="",o.warning("验证码已过期，请重新发送"))},1e3)},N=()=>{w.value&&(clearInterval(w.value),w.value=null),C.value&&(clearInterval(C.value),C.value=null)},Y=async()=>{T.value=!0;try{await D(),o.success("个人信息已刷新")}catch{o.error("刷新个人信息失败")}finally{T.value=!1}},D=async()=>{try{const e=(await $.get("/auth/me")).data.user;Object.assign(l,{id:e.id,username:e.username,email:e.email,nickname:e.nickname||"",bio:e.bio||"",avatar_url:e.avatar_url?e.avatar_url.startsWith("http")?e.avatar_url:`https://tukubackend.vtart.cn${e.avatar_url}`:"",role:e.role,storage_limit:e.storage_limit,used_storage:e.used_storage,created_at:e.created_at}),h.value=e.email}catch(a){throw a}},ee=async()=>{var a,e;if(M.value)try{if(await M.value.validate(),z.value=!0,l.email===h.value){const n={nickname:l.nickname,bio:l.bio},P=await $.put("/auth/profile/simple",n);o.success("个人资料保存成功"),P.data.user&&Object.assign(l,{nickname:P.data.user.nickname||"",bio:P.data.user.bio||""})}else{if(l.email!==h.value){if(!y.value){o.warning("请先发送并输入邮箱验证码");return}if(k.value<=0){o.warning("验证码已过期，请重新发送");return}}const n={username:l.username,nickname:l.nickname,bio:l.bio};l.email!==h.value&&(n.email=l.email,n.emailCode=y.value),await $.put("/auth/profile",n),o.success("个人信息保存成功"),N(),V.value=!1,y.value="",m.value=0,k.value=0}v.value=!1,await B.checkAuth()}catch(i){const n=((e=(a=i.response)==null?void 0:a.data)==null?void 0:e.message)||"保存个人信息失败";o.error(n)}finally{z.value=!1}},ae=()=>{v.value=!1,N(),V.value=!1,y.value="",m.value=0,k.value=0,l.email=h.value,D()},le=a=>{if(_.value=!1,p.value=0,b.value="",a&&a.success&&a.data&&a.data.url){const e=a.data.url+"?t="+Date.now();l.avatar_url=e,o.success(a.message||"头像上传成功"),B.updateUser({avatar_url:e})}else o.error(a.message||"头像上传失败")},se=a=>{p.value=Math.round(a.percent),a.percent<100?b.value=`上传中... ${p.value}%`:(b.value="服务器处理中，请稍候...",p.value=95)},te=a=>{_.value=!1,p.value=0,b.value="",a.message?a.message.includes("Unexpected field")?o.error("上传字段错误，请重试"):a.message.includes("Network Error")?o.error("网络错误，请检查网络连接"):a.message.includes("401")?o.error("登录已过期，请重新登录"):o.error(`上传失败：${a.message}`):o.error("头像上传失败，请重试")},re=a=>`${a}%`,oe=a=>{const e=a.type.startsWith("image/"),i=a.size/1024/1024<10;return e?i?(_.value=!0,p.value=0,b.value="准备上传...",setTimeout(()=>{_.value&&p.value<100&&o.warning("上传时间较长，请耐心等待...")},1e4),setTimeout(()=>{_.value&&p.value<100&&(_.value=!1,p.value=0,b.value="",o.error("上传超时，请重试"))},6e4),!0):(o.error("图片大小不能超过 10MB!"),!1):(o.error("只能上传图片文件!"),!1)},ie=a=>a>=90?"#f56c6c":a>=70?"#e6a23c":"#67c23a",ne=a=>{if(!a)return"未知";try{return new Date(a).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}catch{return a}};return fe(()=>{D()}),_e(()=>{N()}),(a,e)=>{const i=ye,n=be,P=Ee,ue=xe,S=Pe,de=Ae,L=Ce,q=we,A=Be,E=$e,ce=Ie,me=he;return x(),I("div",De,[t("div",Fe,[t("div",Re,[e[7]||(e[7]=t("div",{class:"header-left"},[t("h1",{class:"page-title"},"个人资料"),t("p",{class:"page-subtitle"},"管理您的个人信息和账户设置")],-1)),t("div",je,[s(n,{onClick:Y,loading:T.value},{default:r(()=>[s(i,null,{default:r(()=>[s(g(ke))]),_:1}),e[6]||(e[6]=f(" 刷新 ",-1))]),_:1},8,["loading"])])])]),t("div",Se,[s(me,{gutter:24},{default:r(()=>[s(q,{xs:24,md:8},{default:r(()=>[s(L,{class:"profile-card"},{header:r(()=>[t("div",Le,[e[8]||(e[8]=t("span",null,"个人信息",-1)),s(n,{type:"text",onClick:e[0]||(e[0]=d=>v.value=!v.value)},{default:r(()=>[s(i,null,{default:r(()=>[s(g(Ue))]),_:1}),f(" "+c(v.value?"取消编辑":"编辑"),1)]),_:1})])]),default:r(()=>[t("div",qe,[t("div",Oe,[s(P,{size:120,src:l.avatar_url,class:"profile-avatar"},{default:r(()=>{var d;return[f(c((d=l.username)==null?void 0:d.charAt(0).toUpperCase()),1)]}),_:1},8,["src"]),t("div",Je,[s(ue,{class:"avatar-uploader",action:H.value,headers:Z.value,"show-file-list":!1,"on-success":le,"on-progress":se,"before-upload":oe,"on-error":te,name:"avatar",accept:"image/*"},{default:r(()=>[s(n,{type:"primary",size:"small",loading:_.value},{default:r(()=>[s(i,null,{default:r(()=>[s(g(Ve))]),_:1}),f(" "+c(_.value?"上传中...":"更换头像"),1)]),_:1},8,["loading"])]),_:1},8,["action","headers"]),_.value?(x(),I("div",We,[s(S,{percentage:p.value,"stroke-width":6,"show-text":!0,format:re},null,8,["percentage"]),t("div",Ge,c(b.value),1)])):U("",!0)])]),t("div",He,[t("div",Ze,[e[9]||(e[9]=t("span",{class:"label"},"用户名",-1)),t("span",Ke,c(l.username),1)]),t("div",Qe,[e[10]||(e[10]=t("span",{class:"label"},"邮箱",-1)),t("span",Xe,c(l.email),1)]),t("div",Ye,[e[11]||(e[11]=t("span",{class:"label"},"角色",-1)),s(de,{type:l.role==="admin"?"danger":"primary"},{default:r(()=>[f(c(l.role==="admin"?"管理员":"用户"),1)]),_:1},8,["type"])]),t("div",ea,[e[12]||(e[12]=t("span",{class:"label"},"注册时间",-1)),t("span",aa,c(ne(l.created_at)),1)])])])]),_:1})]),_:1}),s(q,{xs:24,md:16},{default:r(()=>[s(L,{class:"details-card"},{header:r(()=>[...e[13]||(e[13]=[t("span",null,"详细信息",-1)])]),default:r(()=>[s(ce,{model:l,rules:G,ref_key:"profileFormRef",ref:M,"label-width":"100px",class:"profile-form"},{default:r(()=>[s(E,{label:"用户名",prop:"username"},{default:r(()=>[s(A,{modelValue:l.username,"onUpdate:modelValue":e[1]||(e[1]=d=>l.username=d),disabled:!v.value,placeholder:"请输入用户名"},null,8,["modelValue","disabled"])]),_:1}),s(E,{label:"邮箱",prop:"email"},{default:r(()=>[s(A,{modelValue:l.email,"onUpdate:modelValue":e[2]||(e[2]=d=>l.email=d),disabled:!v.value,placeholder:"请输入新邮箱",class:"email-input"},null,8,["modelValue","disabled"]),v.value&&l.email&&l.email!==h.value?(x(),I("div",la,[e[14]||(e[14]=t("div",{class:"verification-header"},[t("span",{class:"verification-title"},"邮箱验证")],-1)),t("div",sa,[s(A,{modelValue:y.value,"onUpdate:modelValue":e[3]||(e[3]=d=>y.value=d),placeholder:"请输入6位验证码",class:"email-code-input",maxlength:"6"},null,8,["modelValue"]),s(n,{type:"primary",size:"small",disabled:m.value>0,onClick:j,class:"send-code-btn"},{default:r(()=>[f(c(m.value>0?`${m.value}s`:"发送验证码"),1)]),_:1},8,["disabled"])]),V.value?(x(),I("div",ta,[t("span",ra,"验证码有效期："+c(k.value)+"s",1),s(n,{type:"text",onClick:K,disabled:m.value>0},{default:r(()=>[f(c(m.value>0?`${m.value}s后重发`:"重新发送"),1)]),_:1},8,["disabled"])])):U("",!0)])):U("",!0)]),_:1}),s(E,{label:"昵称",prop:"nickname"},{default:r(()=>[s(A,{modelValue:l.nickname,"onUpdate:modelValue":e[4]||(e[4]=d=>l.nickname=d),disabled:!v.value,placeholder:"请输入昵称"},null,8,["modelValue","disabled"])]),_:1}),s(E,{label:"个人简介",prop:"bio"},{default:r(()=>[s(A,{modelValue:l.bio,"onUpdate:modelValue":e[5]||(e[5]=d=>l.bio=d),disabled:!v.value,type:"textarea",rows:3,placeholder:"请输入个人简介"},null,8,["modelValue","disabled"])]),_:1}),v.value?U("",!0):(x(),J(E,{key:0,label:"存储使用"},{default:r(()=>[t("div",oa,[s(S,{percentage:R.value,color:ie(R.value),"stroke-width":8},{default:r(({percentage:d})=>[f(c(g(Me)(d)),1)]),_:1},8,["percentage","color"]),t("div",ia,c(g(W)(l.used_storage||0))+" / "+c(g(W)(l.storage_limit||0)),1)])]),_:1})),v.value?(x(),J(E,{key:1},{default:r(()=>[s(n,{type:"primary",onClick:ee,loading:z.value},{default:r(()=>[s(i,null,{default:r(()=>[s(g(Te))]),_:1}),e[15]||(e[15]=f(" 保存修改 ",-1))]),_:1},8,["loading"]),s(n,{onClick:ae},{default:r(()=>[s(i,null,{default:r(()=>[s(g(ze))]),_:1}),e[16]||(e[16]=f(" 取消 ",-1))]),_:1})]),_:1})):U("",!0)]),_:1},8,["model"])]),_:1})]),_:1})]),_:1})])])}}}),Ea=ve(na,[["__scopeId","data-v-45f85767"]]);export{Ea as default};
